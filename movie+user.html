
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Movie App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styles --- */
        :root {
            --primary-blue: #0A84FF;
            --background-color: #F6F7F9;
            --card-bg: #FFFFFF;
            --text-dark: #1A1A1A;
            --text-light: #8E8E93;
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--background-color); color: var(--text-dark); overscroll-behavior-y: contain; }
        
        /* --- Screen Management --- */
        .screen-container { width: 100%; height: 100vh; position: relative; overflow: hidden; }
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--background-color);
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: scale(1.02);
            overflow-y: auto; -ms-overflow-style: none; scrollbar-width: none;
            padding-bottom: calc(100px + var(--safe-area-bottom));
        }
        .screen::-webkit-scrollbar { display: none; }
        .screen.active { opacity: 1; visibility: visible; transform: scale(1); }

        /* --- Loading --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--background-color);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.3s ease;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Header & Components --- */
        .home-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; padding-top: calc(20px + var(--safe-area-top)); }
        
        /* Profile Pic Style - Initially Hidden */
        .profile-pic { 
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer; object-fit: cover; 
            border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
            background-color: #e0e0e0; transition: transform 0.2s;
            display: none; /* Hidden for guests */
        }
        .profile-pic:active { transform: scale(0.95); }

        /* --- SLIDER STYLES --- */
        .slider-container { margin: 15px 20px; height: 180px; border-radius: 16px; overflow: hidden; position: relative; box-shadow: var(--card-shadow); }
        .slider-wrapper { display: flex; width: 100%; height: 100%; transition: transform 0.5s ease-in-out; }
        .slide {
            min-width: 100%; height: 100%; background-size: cover; background-position: center; background-repeat: no-repeat;
            position: relative; display: flex; align-items: flex-end; cursor: pointer;
        }
        .slide::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.1) 60%, transparent 100%); }
        .slide-content { position: relative; z-index: 2; padding: 15px 20px; color: white; width: 100%; }
        .slide-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .slide-genre { font-size: 12px; opacity: 0.9; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .slider-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 3; }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: white; width: 16px; border-radius: 3px; }

        /* --- Sections --- */
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-top: 25px; margin-bottom: 15px; }
        .section-header h2 { font-size: 18px; font-weight: 600; }
        .section-header a { font-size: 13px; color: var(--text-light); text-decoration: none; cursor: pointer; font-weight: 500; }
        
        .channel-list { display: flex; gap: 15px; padding: 0 20px; overflow-x: auto; scrollbar-width: none; }
        .channel-list::-webkit-scrollbar { display: none; }
        .channel-item { flex-shrink: 0; cursor: pointer; transition: transform 0.2s; }
        .channel-item:active { transform: scale(0.95); }
        .channel-item img { height: 44px; width: auto; max-width: 110px; object-fit: contain; background: white; padding: 8px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); }

        .movies-list { display: flex; gap: 15px; overflow-x: auto; padding: 0 20px 20px 20px; scrollbar-width: none; }
        .movies-list::-webkit-scrollbar { display: none; }
        .movie-card { flex-shrink: 0; width: 140px; cursor: pointer; }
        .movie-card .poster { width: 100%; height: 200px; border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow); background: #eee; }
        .movie-card .poster img { width: 100%; height: 100%; object-fit: cover; }
        .movie-card-info { padding-top: 10px; }
        .movie-card-info h3 { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .movie-card-info .meta { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; color: var(--text-light); font-size: 11px; }
        
        /* --- Menu & Generic Pages --- */
        .page-header { padding: 20px 20px 10px 20px; padding-top: calc(20px + var(--safe-area-top)); font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .back-icon { cursor: pointer; font-size: 28px; padding-right: 5px; }
        
        .menu-hero {
            background: linear-gradient(135deg, #0A84FF 0%, #0055D4 100%);
            color: white; margin: 10px 20px 25px 20px; padding: 25px; border-radius: 20px; display: flex; align-items: center; box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
        }
        /* Menu Avatar - Initially Hidden */
        .menu-avatar { width: 70px; height: 70px; border-radius: 50%; margin-right: 15px; border: 3px solid rgba(255,255,255,0.5); background: #fff; object-fit: cover; display: none; }
        .menu-user-details h3 { font-size: 18px; font-weight: 600; }
        .menu-user-details p { font-size: 12px; opacity: 0.8; }
        
        .menu-group { background: var(--card-bg); border-radius: 20px; margin: 0 20px 20px 20px; box-shadow: var(--card-shadow); overflow: hidden; }
        .menu-item { display: flex; align-items: center; padding: 18px; cursor: pointer; border-bottom: 1px solid var(--background-color); transition: background 0.2s; }
        .menu-item:active { background: #f0f0f0; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item .icon { margin-right: 15px; width: 24px; color: var(--text-dark); display: flex; justify-content: center; }
        .menu-item span { flex-grow: 1; font-weight: 500; font-size: 15px; }
        .menu-item .arrow { color: var(--text-light); font-size: 18px; }
        .menu-item.logout span { color: #FF3B30; }
        
        /* --- Auth Styles --- */
        .auth-container { padding: 30px; display: flex; flex-direction: column; justify-content: center; height: 90%; }
        .auth-header { text-align: center; margin-bottom: 40px; }
        .auth-header h1 { font-size: 32px; font-weight: 700; margin-bottom: 10px; color: var(--text-dark); }
        .auth-header p { color: var(--text-light); }
        .auth-input { width: 100%; padding: 16px; background: #FFFFFF; border: 1px solid #E5E5EA; border-radius: 12px; margin-bottom: 15px; font-size: 16px; outline: none; transition: 0.3s; }
        .auth-input:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1); }
        select.auth-input { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        .auth-btn { width: 100%; padding: 16px; background: var(--primary-blue); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3); transition: transform 0.2s; }
        .auth-btn:active { transform: scale(0.98); }
        .auth-footer { margin-top: 25px; text-align: center; font-size: 14px; color: var(--text-light); }
        .auth-link { color: var(--primary-blue); font-weight: 600; cursor: pointer; margin-left: 5px; }

        /* --- Details Screen --- */
        #details-screen { background-color: #141A31; color: white; }
        .details-bg { position: absolute; top: 0; left: 0; width: 100%; height: 65%; object-fit: cover; opacity: 0.6; }
        .details-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, #141A31 40%, transparent 80%); }
        .details-content { position: relative; z-index: 10; padding: 20px; margin-top: 45vh; text-align: center; }
        .details-content h1 { font-size: 30px; margin-bottom: 10px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .action-buttons-container { display: flex; flex-direction: column; gap: 15px; margin-top: 25px; padding: 0 10px; }
        .main-btn { display: flex; justify-content: center; align-items: center; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; gap: 10px; width: 100%; transition: transform 0.2s; }
        .main-btn:active { transform: scale(0.98); }
        #play-btn-main { background-color: #FFFFFF; color: #000000; }
        #download-btn-main { background-color: rgba(255, 255, 255, 0.15); color: #FFFFFF; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .meta-actions { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; }
        .save-btn-circle { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: background-color 0.3s; }
        
        /* --- List & Grid --- */
        .listing-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px 15px; padding: 20px; }
        .placeholder-content { display: none; flex-direction: column; align-items: center; justify-content: center; height: 60vh; text-align: center; color: var(--text-light); }
        .placeholder-content.visible { display: flex; }
        .placeholder-content svg { width: 60px; height: 60px; margin-bottom: 20px; opacity: 0.5; }
        
        /* --- Download List Styles --- */
        .download-list-container { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .download-card { 
            display: flex; align-items: center; background: #fff; border-radius: 15px; 
            overflow: hidden; box-shadow: var(--card-shadow); cursor: pointer; height: 100px; 
            transition: transform 0.2s; width: 100%;
        }
        .download-card:active { transform: scale(0.98); }
        .download-card-poster { width: 80px; height: 100%; object-fit: cover; }
        .download-card-info { flex: 1; padding: 0 15px; display: flex; flex-direction: column; justify-content: center; }
        .download-card-info h3 { font-size: 15px; font-weight: 600; margin-bottom: 5px; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .download-card-info p { font-size: 12px; color: var(--text-light); }
        .download-actions { padding-right: 15px; display: flex; gap: 10px; }
        .delete-btn { color: #FF3B30; padding: 8px; }
        
        /* --- Search --- */
        .search-header { padding: 10px 20px; padding-top: calc(10px + var(--safe-area-top)); display: flex; gap: 10px; align-items: center; }
        .search-input-wrapper { flex: 1; background: #EFEFF4; border-radius: 10px; display: flex; align-items: center; padding: 0 10px; }
        .search-input { width: 100%; padding: 12px; border: none; background: transparent; outline: none; }

        /* --- Bottom Nav --- */
        .bottom-nav-container { position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; padding: 15px; padding-bottom: calc(15px + var(--safe-area-bottom)); }
        .bottom-nav { background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); height: 65px; border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 0 10px; border: 1px solid rgba(255, 255, 255, 0.5); }
        .nav-item { display: flex; flex-direction: column; align-items: center; width: 50px; cursor: pointer; justify-content: center; position: relative; }
        .nav-item svg { width: 24px; height: 24px; color: var(--text-light); transition: 0.3s; }
        .nav-item.active svg { color: var(--primary-blue); }
        .nav-search-btn { width: 50px; height: 50px; background: var(--primary-blue); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; margin-top: -25px; box-shadow: 0 8px 20px rgba(10, 132, 255, 0.4); border: 4px solid var(--card-bg); }

    </style>
</head>
<body>
    <div id="loading-overlay"><div class="loader"></div></div>

    <div class="screen-container">
        
        <!-- LOGIN SCREEN -->
        <div id="login-screen" class="screen">
            <div class="auth-container">
                <div class="auth-header">
                    <h1>Welcome Back</h1>
                    <p>Sign in to continue to Movie App</p>
                </div>
                <input type="email" id="login-email" class="auth-input" placeholder="Email Address">
                <input type="password" id="login-password" class="auth-input" placeholder="Password">
                <div style="text-align: right; margin-bottom: 20px;">
                    <span class="auth-link" style="font-size: 14px;" onclick="navigateTo('#forgot-password-screen')">Forgot Password?</span>
                </div>
                <button class="auth-btn" id="btn-login-action">Sign In</button>
                <div class="auth-footer">
                    Don't have an account? <span class="auth-link" onclick="navigateTo('#register-screen')">Sign Up</span>
                </div>
                <div class="auth-footer">
                    <span class="auth-link" style="color:var(--text-light)" onclick="navigateTo('#home-screen')">Skip for now</span>
                </div>
            </div>
        </div>

        <!-- REGISTER SCREEN -->
        <div id="register-screen" class="screen">
            <div class="auth-container">
                <div class="auth-header">
                    <h1>Create Account</h1>
                    <p>Sign up to get started</p>
                </div>
                <input type="text" id="reg-name" class="auth-input" placeholder="Full Name">
                <input type="email" id="reg-email" class="auth-input" placeholder="Email Address">
                <input type="password" id="reg-password" class="auth-input" placeholder="Password">
                
                <!-- Gender Selector -->
                <select id="reg-gender" class="auth-input">
                    <option value="" disabled selected>Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>

                <button class="auth-btn" id="btn-register-action">Sign Up</button>
                <div class="auth-footer">
                    Already have an account? <span class="auth-link" onclick="navigateTo('#login-screen')">Sign In</span>
                </div>
            </div>
        </div>

        <!-- FORGOT PASSWORD SCREEN -->
        <div id="forgot-password-screen" class="screen">
             <div class="page-header"><span class="back-icon" onclick="goBack()">‹</span> Back</div>
            <div class="auth-container">
                <div class="auth-header">
                    <h1>Reset Password</h1>
                    <p>Enter your email to receive a reset link</p>
                </div>
                <input type="email" id="reset-email" class="auth-input" placeholder="Email Address">
                <button class="auth-btn" id="btn-reset-action">Send Reset Link</button>
            </div>
        </div>

        <!-- HOME SCREEN -->
        <div id="home-screen" class="screen active">
            <header class="home-header">
                <!-- Header Profile Pic - Hidden by default, visible only if logged in -->
                <img id="header-profile-pic" src="" alt="Profile" class="profile-pic" onclick="handleProfileClick()">
                <div id="header-placeholder" style="flex:1;"></div> <!-- Spacer -->
            </header>
            
            <div class="slider-container">
                <div class="slider-wrapper" id="hero-slider"></div>
                <div class="slider-dots" id="slider-dots"></div>
            </div>

            <div class="section-header"><h2>Channels</h2><a class="see-all-link" data-category="channel">See all</a></div>
            <div class="channel-list" id="home-channels-container"></div>
            
            <div class="section-header"><h2>New Movies</h2><a class="see-all-link" data-category="new">See all</a></div>
            <div class="movies-list" id="new-movies-container"></div>
            
            <div class="section-header"><h2>Popular</h2><a class="see-all-link" data-category="all">See all</a></div>
            <div class="movies-list" id="popular-movies-container"></div>
        </div>

        <!-- MENU SCREEN -->
        <div id="menu-screen" class="screen">
            <div class="page-header">Menu</div>
            
            <div class="menu-hero" onclick="navigateTo('#settings-screen')">
                <!-- Menu Avatar - Hidden by default -->
                <img id="menu-profile-pic" src="" class="menu-avatar">
                <div class="menu-user-details">
                    <h3 id="menu-user-name">Guest User</h3>
                    <p id="menu-user-email">Sign in to sync data</p>
                </div>
                <div style="margin-left:auto; font-size:20px;">›</div>
            </div>

            <div class="menu-group">
                <div class="menu-item" onclick="navigateTo('#saved-screen')">
                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256"><path d="M192,24H96A16,16,0,0,0,80,40V56H64A16,16,0,0,0,48,72V224a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V40A16,16,0,0,0,192,24ZM168,224H64V72h16v56a8,8,0,0,0,12,5.66L128,120l36,13.66A8,8,0,0,0,176,128V72h16V224h-24Zm24-168H96V40h96Z"></path></svg></div>
                    <span>My List (Saved)</span>
                    <span class="arrow">›</span>
                </div>
                <div class="menu-item" onclick="navigateTo('#downloads-screen')">
                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256"><path d="M208,120v64a16,16,0,0,1-16,16H64a16,16,0,0,1-16-16V120H32v64a32,32,0,0,0,32,32H192a32,32,0,0,0,32-32V120ZM120,24V128.49l-20.24-20.25a12,12,0,0,0-17,17l40,40a12,12,0,0,0,17,0l40-40a12,12,0,1,0-17-17L136,128.49V24a12,12,0,0,0-24,0Z"></path></svg></div>
                    <span>Downloads</span>
                    <span class="arrow">›</span>
                </div>
            </div>

            <div class="menu-group">
                <div class="menu-item" onclick="navigateTo('#settings-screen')">
                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256"><path d="M168,88a40,40,0,1,1-40-40A40,40,0,0,1,168,88Zm65.42,86.58-25.74-14.86a88.33,88.33,0,0,0,0-27.44l25.74-14.86a12,12,0,0,0,6-10.37V91.63a12,12,0,0,0-6-10.37l-25.74-14.86a88.33,88.33,0,0,0-23.77-13.73L173.33,26.6a12,12,0,0,0-10.37-6H101a12,12,0,0,0-10.37,6L82.08,52.67a88.33,88.33,0,0,0-23.77,13.73L32.58,51.54a12,12,0,0,0-10.37,6V78.37a12,12,0,0,0,6,10.37l25.74,14.86a88.33,88.33,0,0,0,0,27.44L28.21,146a12,12,0,0,0-6,10.37v10.74a12,12,0,0,0,6,10.37l25.74,14.86a88.33,88.33,0,0,0,23.77,13.73L92.67,229.4a12,12,0,0,0,10.37,6h61.92a12,12,0,0,0,10.37-6l8.55-26.07a88.33,88.33,0,0,0,23.77-13.73l25.74,14.86a12,12,0,0,0,10.37-6V183a12,12,0,0,0-6-10.37ZM128,152a64,64,0,1,1,64-64A64.07,64.07,0,0,1,128,152Z"></path></svg></div>
                    <span>App Settings</span>
                    <span class="arrow">›</span>
                </div>
            </div>

            <div class="menu-group" id="logout-group">
                <div class="menu-item logout" onclick="handleLogout()">
                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256"><path d="M112,48V36a12,12,0,0,1,12-12h80a12,12,0,0,1,12,12V220a12,12,0,0,1-12,12h-80a12,12,0,0,1-12-12v-12a12,12,0,0,1,24,0v4h72V44h-72v4a12,12,0,0,1-24,0ZM118.11,134.11,84.4,167.73a12,12,0,0,1-17-17l24-24H24a12,12,0,0,1,0-24H91.43l-24-24a12,12,0,0,1,17-17l33.71,33.72a12,12,0,0,1,0,17Z"></path></svg></div>
                    <span>Log Out</span>
                </div>
            </div>
        </div>

        <!-- SAVED SCREEN -->
        <div id="saved-screen" class="screen">
            <div class="page-header"><span class="back-icon" onclick="goBack()">‹</span> Saved</div>
            <div id="saved-grid" class="listing-grid"></div>
            <div id="saved-placeholder" class="placeholder-content"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256"><path d="M192,24H96A16,16,0,0,0,80,40V56H64A16,16,0,0,0,48,72V224a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V40A16,16,0,0,0,192,24ZM168,224H64V72h16v56a8,8,0,0,0,12,5.66L128,120l36,13.66A8,8,0,0,0,176,128V72h16V224h-24Zm24-168H96V40h96Z"></path></svg><p>No movies saved yet.</p></div>
        </div>
        
        <!-- DOWNLOADS SCREEN -->
        <div id="downloads-screen" class="screen">
            <div class="page-header"><span class="back-icon" onclick="goBack()">‹</span> Downloads</div>
            <div id="downloads-list-container" class="download-list-container"></div>
            <div id="downloads-placeholder" class="placeholder-content"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256"><path d="M208,120v64a16,16,0,0,1-16,16H64a16,16,0,0,1-16-16V120H32v64a32,32,0,0,0,32,32H192a32,32,0,0,0,32-32V120ZM120,24V128.49l-20.24-20.25a12,12,0,0,0-17,17l40,40a12,12,0,0,0,17,0l40-40a12,12,0,1,0-17-17L136,128.49V24a12,12,0,0,0-24,0Z"></path></svg><p>No movies downloaded yet.</p></div>
        </div>

        <div id="settings-screen" class="screen">
            <div class="page-header"><span class="back-icon" onclick="goBack()">‹</span> Settings</div>
            <div style="padding: 20px;"><p>App Version: 1.0.0</p><p>Notifications: On</p></div>
        </div>

        <!-- SEARCH SCREEN -->
        <div id="search-screen" class="screen">
            <header class="search-header">
                <div class="search-input-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#8E8E93" viewBox="0 0 256 256"><path d="M228.24,219.76l-51.38-51.38a92.21,92.21,0,1,0-8.48,8.48l51.38,51.38a6,6,0,0,0,8.48-8.48ZM44,112a68,68,0,1,1,68,68A68.08,68.08,0,0,1,44,112Z"></path></svg>
                    <input type="text" id="search-input" class="search-input" placeholder="Search movies...">
                </div>
                <span onclick="goBack()" style="color:var(--primary-blue); padding: 10px; cursor: pointer;">Cancel</span>
            </header>
            <div id="search-results-container" class="listing-grid"></div>
        </div>

        <!-- DETAILS SCREEN -->
        <div id="details-screen" class="screen">
            <img id="details-bg-poster" src="" class="details-bg">
            <div class="details-gradient"></div>
            <div style="position:absolute; top:calc(15px + var(--safe-area-top)); left:15px; z-index:20; background:rgba(0,0,0,0.3); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;" onclick="goBack()">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="white" viewBox="0 0 256 256"><path d="M168.49,199.51a12,12,0,0,1-17,17l-80-80a12,12,0,0,1,0-17l80-80a12,12,0,0,1,17,17L97,128Z"></path></svg>
            </div>
            <div class="details-content">
                <h1 id="details-title">Movie Title</h1>
                <p id="details-meta" style="color:#ccc; font-size:14px;">2023 | Action | 1h 40m</p>
                
                <div class="action-buttons-container">
                    <button class="main-btn" id="play-btn-main">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M240,128a15.74,15.74,0,0,1-7.6,13.51L88.32,229.65a16,16,0,0,1-16.2.3A15.86,15.86,0,0,1,64,216.13V39.87a15.86,15.86,0,0,1,8.12-13.82,16,16,0,0,1,16.2.3L232.4,86.49A15.74,15.74,0,0,1,240,128Z"></path></svg>
                        Play Movie
                    </button>
                    <button class="main-btn" id="download-btn-main">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M216,152v56a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V152a8,8,0,0,1,16,0v48H200V152a8,8,0,0,1,16,0ZM122.34,157.66a8,8,0,0,0,11.32,0l48-48a8,8,0,0,0-11.32-11.32L136,132.69V40a8,8,0,0,0-16,0v92.69L85.66,98.34a8,8,0,0,0-11.32,11.32Z"></path></svg>
                        Download
                    </button>
                </div>

                <div class="meta-actions">
                    <div class="save-btn-circle" id="save-movie-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 256 256"><path d="M192,24H96A16,16,0,0,0,80,40V56H64A16,16,0,0,0,48,72V224a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V40A16,16,0,0,0,192,24ZM168,224H64V72h16v56a8,8,0,0,0,12,5.66L128,120l36,13.66A8,8,0,0,0,176,128V72h16V224h-24Zm24-168H96V40h96Z"></path></svg>
                    </div>
                    <p style="font-size: 12px; color: #aaa;">My List</p>
                </div>
                <p id="details-description" style="margin-top:20px; color:#aaa; font-size:13px; line-height: 1.6; max-width: 400px; margin-left: auto; margin-right: auto;"></p>
            </div>
        </div>

        <!-- LISTING SCREEN -->
        <div id="listing-screen" class="screen">
            <div class="page-header"><span class="back-icon" onclick="goBack()">‹</span> <span id="listing-title">Movies</span></div>
            <div id="listing-grid-container" class="listing-grid"></div>
        </div>

        <!-- BOTTOM NAV (Menu Icon at End) -->
        <div class="bottom-nav-container">
            <div class="bottom-nav">
                <!-- Home -->
                <div class="nav-item active" data-target="#home-screen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path fill="currentColor" d="M224,115.55V208a16,16,0,0,1-16,16H168a16,16,0,0,1-16-16V168a8,8,0,0,0-8-8H112a8,8,0,0,0-8,8v40a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V115.55a16,16,0,0,1,5.17-11.78l96-89.6a16,16,0,0,1,21.66,0l96,89.6A16,16,0,0,1,224,115.55Z"></path></svg></div>
                <!-- Saved -->
                <div class="nav-item" data-target="#saved-screen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path fill="currentColor" d="M192,24H96A16,16,0,0,0,80,40V56H64A16,16,0,0,0,48,72V224a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V40A16,16,0,0,0,192,24ZM168,224H64V72h16v56a8,8,0,0,0,12,5.66L128,120l36,13.66A8,8,0,0,0,176,128V72h16V224h-24Zm24-168H96V40h96Z"></path></svg></div>
                <!-- Search -->
                <div class="nav-search-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg></div>
                <!-- Downloads -->
                <div class="nav-item" data-target="#downloads-screen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path fill="currentColor" d="M208,120v64a16,16,0,0,1-16,16H64a16,16,0,0,1-16-16V120H32v64a32,32,0,0,0,32,32H192a32,32,0,0,0,32-32V120ZM120,24V128.49l-20.24-20.25a12,12,0,0,0-17,17l40,40a12,12,0,0,0,17,0l40-40a12,12,0,1,0-17-17L136,128.49V24a12,12,0,0,0-24,0Z"></path></svg></div>
                <!-- Menu Icon (Hamburger) -->
                <div class="nav-item" id="nav-menu-item" onclick="handleProfileClick()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path fill="currentColor" d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAUjV_tUlWb5S7A8HSoTcU3vjvbuPzjtvI",
          authDomain: "app-1-e0ede.firebaseapp.com",
          databaseURL: "https://app-1-e0ede-default-rtdb.firebaseio.com",
          projectId: "app-1-e0ede",
          storageBucket: "app-1-e0ede.firebasestorage.app",
          messagingSenderId: "679519684721",
          appId: "1:679519684721:web:56b78c83b7fc66c30c73d0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let movies = {};
        let channels = [];
        let savedMovieIds = JSON.parse(localStorage.getItem('savedMovies')) || [];
        let downloadedMovies = JSON.parse(localStorage.getItem('downloadedMovies')) || [];

        document.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateMenuUI(user);
            });

            try {
                const movieSnap = await db.collection('movies').get();
                movieSnap.forEach(doc => movies[doc.id] = doc.data());

                const channelSnap = await db.collection('channels').get();
                channelSnap.forEach(doc => channels.push({id: doc.id, ...doc.data()}));
                
                initializeApp(movies, channels);
                loadingOverlay.style.opacity = 0;
                setTimeout(() => loadingOverlay.style.display = 'none', 300);
            } catch(e) { 
                console.error("Error loading data:", e); 
                loadingOverlay.innerHTML = 'Error Loading Content'; 
            }
        });

        function initializeApp(data, channelData) {
            let history = ['#home-screen'];
            
            window.navigateTo = (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const targetScreen = document.querySelector(id);
                if (targetScreen) targetScreen.classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const activeNav = document.querySelector(`.nav-item[data-target="${id}"]`);
                if(activeNav) activeNav.classList.add('active');
                
                // Handle Menu Item Active State
                if(id === '#menu-screen') {
                     document.getElementById('nav-menu-item').classList.add('active');
                }

                if(id !== history[history.length-1]) history.push(id);
                
                if(id === '#saved-screen') renderSaved();
                if(id === '#downloads-screen') renderDownloads();
            };
            
            window.goBack = () => {
                if(history.length > 1) history.pop();
                navigateTo(history[history.length-1]);
            };

            window.handleProfileClick = () => navigateTo(currentUser ? '#menu-screen' : '#login-screen');

            document.getElementById('btn-login-action').onclick = async () => {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                try {
                    await auth.signInWithEmailAndPassword(email, pass);
                    navigateTo('#home-screen');
                } catch(e) { alert("Login Failed: " + e.message); }
            };

            document.getElementById('btn-register-action').onclick = async () => {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const pass = document.getElementById('reg-password').value;
                const gender = document.getElementById('reg-gender').value;

                if (!name || !email || !pass || !gender) {
                    alert("Please fill all fields including gender.");
                    return;
                }

                try {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    const avatarType = gender === 'female' ? 'girl' : 'boy';
                    const avatarUrl = `https://avatar.iran.liara.run/public/${avatarType}?username=${encodeURIComponent(name)}`;
                    
                    // Update Auth Profile
                    await res.user.updateProfile({ 
                        displayName: name,
                        photoURL: avatarUrl
                    });
                    
                    // Write to Firestore
                    await db.collection('users').doc(res.user.uid).set({
                        name: name, email: email, gender: gender, uid: res.user.uid,
                        photoUrl: avatarUrl,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Force UI Update immediately so user sees profile instantly without reload
                    updateMenuUI(res.user);
                    
                    navigateTo('#home-screen');
                } catch(e) { alert("Registration Failed: " + e.message); }
            };

            document.getElementById('btn-reset-action').onclick = async () => {
                const email = document.getElementById('reset-email').value;
                try {
                    await auth.sendPasswordResetEmail(email);
                    alert("Password reset link sent to " + email);
                    goBack();
                } catch(e) { alert("Error: " + e.message); }
            };

            window.handleLogout = async () => {
                await auth.signOut();
                navigateTo('#login-screen');
            };

            // Robust UI Updater (Fetches from DB if Auth is slow)
            async function updateMenuUI(user) {
                const headerPic = document.getElementById('header-profile-pic');
                const menuPic = document.getElementById('menu-profile-pic');
                
                if(user) {
                    let name = user.displayName;
                    let photo = user.photoURL;

                    // Fallback: If name/photo is missing (sync lag), fetch from Firestore
                    if(!name || !photo) {
                        try {
                            const doc = await db.collection('users').doc(user.uid).get();
                            if(doc.exists) {
                                const userData = doc.data();
                                name = userData.name;
                                photo = userData.photoUrl;
                            }
                        } catch(e) { console.log("DB Fetch error", e); }
                    }

                    // Fallback Default
                    if(!name) name = "User";
                    if(!photo) photo = `https://avatar.iran.liara.run/public/boy?username=${encodeURIComponent(name)}`;

                    document.getElementById('menu-user-name').textContent = name;
                    document.getElementById('menu-user-email').textContent = user.email;
                    document.getElementById('logout-group').style.display = 'block';
                    
                    // Show profile pictures
                    menuPic.src = photo;
                    menuPic.style.display = 'block';
                    headerPic.src = photo;
                    headerPic.style.display = 'block';

                } else {
                    // Guest: Hide Avatar
                    document.getElementById('menu-user-name').textContent = 'Guest User';
                    document.getElementById('menu-user-email').textContent = 'Sign in to sync data';
                    document.getElementById('logout-group').style.display = 'none';
                    
                    // Hide profile pictures for Guest
                    menuPic.style.display = 'none';
                    headerPic.style.display = 'none';
                }
            }

            const channelContainer = document.getElementById('home-channels-container');
            channelContainer.innerHTML = channelData.length > 0 ? channelData.map(c => `
                <div class="channel-item" onclick="window.open('${c.streamUrl}', '_blank')">
                    <img src="${c.logo}" alt="${c.name}" onerror="this.style.display='none'">
                </div>
            `).join('') : '<p style="font-size:12px; color:#999; padding:10px;">No channels available</p>';

            const sliderWrapper = document.getElementById('hero-slider');
            const sliderDots = document.getElementById('slider-dots');
            const sliderMovies = Object.entries(data).filter(([_, m]) => m.isSlider); 
            if(sliderMovies.length > 0) {
                sliderWrapper.innerHTML = sliderMovies.map(([id, m]) => `
                    <div class="slide" onclick="openDetails('${id}')" style="background-image: url('${m.banner || m.poster}')">
                        <div class="slide-content">
                            <div class="slide-title">${m.title}</div>
                            <div class="slide-genre">${m.genre}</div>
                        </div>
                    </div>`).join('');
                sliderDots.innerHTML = sliderMovies.map((_, i) => `<div class="dot ${i===0?'active':''}"></div>`).join('');
                let currentSlide = 0;
                setInterval(() => {
                    currentSlide = (currentSlide + 1) % sliderMovies.length;
                    sliderWrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
                    document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide));
                }, 4000);
            }

            const createCard = (id, m) => `<div class="movie-card" onclick="openDetails('${id}')"><div class="poster"><img src="${m.poster}" loading="lazy" alt="${m.title}"></div><div class="movie-card-info"><h3>${m.title}</h3><div class="meta"><span>${m.year}</span><span>${m.rating} ★</span></div></div></div>`;
            document.getElementById('new-movies-container').innerHTML = Object.entries(data).filter(([_, m]) => m.isNew).map(([id, m]) => createCard(id, m)).join('');
            document.getElementById('popular-movies-container').innerHTML = Object.entries(data).slice(0, 10).map(([id, m]) => createCard(id, m)).join('');

            window.openDetails = (id) => {
                const m = data[id];
                document.getElementById('details-bg-poster').src = m.banner || m.poster;
                document.getElementById('details-title').textContent = m.title;
                document.getElementById('details-meta').textContent = `${m.year} | ${m.genre} | ${m.duration}`;
                document.getElementById('details-description').textContent = m.description || '';
                
                document.getElementById('play-btn-main').onclick = () => m.playUrl ? window.open(m.playUrl, '_blank') : alert("Link unavailable");
                
                document.getElementById('download-btn-main').onclick = () => {
                    if (!currentUser) {
                        const confirmLogin = confirm("মুভি ডাউনলোড করার জন্য আপনাকে রেজিস্ট্রেশন বা লগইন করতে হবে। আপনি কি এখন রেজিস্ট্রেশন করতে চান?");
                        if (confirmLogin) navigateTo('#register-screen');
                    } else {
                        if (m.downloadUrl) {
                            if(!downloadedMovies.some(dm => dm.id === id)){
                                downloadedMovies.push({id: id, ...m});
                                localStorage.setItem('downloadedMovies', JSON.stringify(downloadedMovies));
                                alert("Download started! Check 'Downloads' tab.");
                            } else {
                                alert("Already in downloads.");
                            }
                            window.open(m.downloadUrl, '_blank');
                        } else {
                            alert("Download link not available.");
                        }
                    }
                };
                
                updateSaveButton(id);
                document.getElementById('save-movie-btn').onclick = () => {
                    if(savedMovieIds.includes(id)) savedMovieIds = savedMovieIds.filter(sid => sid !== id);
                    else savedMovieIds.push(id);
                    localStorage.setItem('savedMovies', JSON.stringify(savedMovieIds));
                    updateSaveButton(id);
                };
                
                navigateTo('#details-screen');
            };

            function updateSaveButton(id) {
                const btn = document.getElementById('save-movie-btn');
                if(savedMovieIds.includes(id)) { 
                    btn.style.background = 'var(--primary-blue)'; 
                    btn.style.borderColor = 'var(--primary-blue)';
                } else { 
                    btn.style.background = 'rgba(255,255,255,0.1)'; 
                    btn.style.borderColor = 'rgba(255,255,255,0.2)';
                }
            }

            function renderSaved() {
                const savedContainer = document.getElementById('saved-grid');
                const savedList = Object.entries(data).filter(([id]) => savedMovieIds.includes(id));
                savedContainer.innerHTML = savedList.length ? savedList.map(([id, m]) => createCard(id, m)).join('') : '';
                document.getElementById('saved-placeholder').classList.toggle('visible', !savedList.length);
            }

            function renderDownloads() {
                const dlContainer = document.getElementById('downloads-list-container');
                const dlPlaceholder = document.getElementById('downloads-placeholder');
                
                if(downloadedMovies.length === 0) {
                    dlContainer.innerHTML = '';
                    dlPlaceholder.classList.add('visible');
                } else {
                    dlPlaceholder.classList.remove('visible');
                    dlContainer.innerHTML = downloadedMovies.map((m, index) => `
                        <div class="download-card">
                            <img src="${m.poster}" class="download-card-poster">
                            <div class="download-card-info" onclick="openDetails('${m.id}')">
                                <h3>${index + 1}. ${m.title}</h3>
                                <p>${m.year} | ${m.duration}</p>
                            </div>
                            <div class="download-actions">
                                <div class="delete-btn" onclick="deleteDownload('${m.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            window.deleteDownload = (id) => {
                downloadedMovies = downloadedMovies.filter(m => m.id !== id);
                localStorage.setItem('downloadedMovies', JSON.stringify(downloadedMovies));
                renderDownloads();
            };

            document.querySelector('.nav-search-btn').onclick = () => navigateTo('#search-screen');
            document.getElementById('search-input').oninput = (e) => {
                const val = e.target.value.toLowerCase();
                const res = Object.entries(data).filter(([_, m]) => m.title.toLowerCase().includes(val));
                document.getElementById('search-results-container').innerHTML = res.map(([id, m]) => createCard(id, m)).join('');
            };

            document.querySelectorAll('.see-all-link').forEach(l => {
                l.onclick = (e) => {
                    const cat = e.target.dataset.category;
                    const list = (cat === 'new') ? Object.entries(data).filter(([_, m]) => m.isNew) : Object.entries(data);
                    document.getElementById('listing-grid-container').innerHTML = list.map(([id, m]) => createCard(id, m)).join('');
                    document.getElementById('listing-title').textContent = cat === 'new' ? 'New Movies' : 'All Movies';
                    navigateTo('#listing-screen');
                }
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if(item.dataset.target) {
                    item.onclick = () => navigateTo(item.dataset.target);
                }
            });
        }
    </script>
</body>
</html>